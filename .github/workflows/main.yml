# ------------------------------------------------------
# Workflow åç¨±ï¼šé¡¯ç¤ºåœ¨ GitHub Actions å·¦å´åˆ—è¡¨
# ------------------------------------------------------
name: Vprofile CICD Workflow

# ------------------------------------------------------
# onï¼šå®šç¾© Workflow çš„è§¸ç™¼æ¢ä»¶
# ------------------------------------------------------
on:
  push:
    # ä»»ä½• push åˆ° main æˆ– develop åˆ†æ”¯éƒ½æœƒè§¸ç™¼
    branches: [ "main", "develop" ]

  pull_request:
    # ä»»ä½• PR é€åˆ° main æˆ– develop æœƒè§¸ç™¼
    branches: [ "main", "develop" ]

  # æ‰‹å‹•è§¸ç™¼ workflowï¼ˆUI é»æ“ŠåŸ·è¡Œï¼‰
  workflow_dispatch:

  # å®šæ™‚åŸ·è¡Œï¼ˆCRON è¡¨é”å¼ï¼‰
  # æ ¼å¼ï¼šåˆ† æ™‚ æ—¥ æœˆ æ˜ŸæœŸ
  # æ­¤è™•ç‚ºï¼šæ¯é€±ä¸€è‡³é€±äº”ï¼Œ14:10ï¼ˆUTCï¼‰
  schedule:
    - cron: "10 14 * * 1-5"


# ------------------------------------------------------
# permissionsï¼šé™åˆ¶ GitHub Token æ¬Šé™ï¼Œæå‡å®‰å…¨æ€§
# ------------------------------------------------------
permissions:
  contents: read   # Token åªèƒ½è®€å–å…§å®¹ï¼Œä¸èƒ½å¯«å…¥


# ------------------------------------------------------
# jobsï¼šå®šç¾©æ•´å€‹å·¥ä½œæµç¨‹çš„æ‰€æœ‰ Job
# ------------------------------------------------------
jobs:

  # ======================================================
  # Job 1ï¼šBuildï¼ˆç·¨è­¯ã€æ‰“åŒ…ã€ç”¢å‡º WARã€é¡¯ç¤ºå¤±æ•—é€šçŸ¥ï¼‰
  # ======================================================
  Build:
    runs-on: ubuntu-latest   # åŸ·è¡Œç’°å¢ƒä½¿ç”¨ GitHub Ubuntu Runner

    steps:
      # -----------------------------
      # æ­¥é©Ÿ 1ï¼šä¸‹è¼‰ Repo ç¨‹å¼ç¢¼
      # actions/checkout æ˜¯å®˜æ–¹æä¾›çš„å‹•ä½œ
      # fetch-depth: 0 â†’ æŠ“å®Œæ•´ Git æ­·å²ï¼ˆé shallow cloneï¼‰
      # -----------------------------
      - name: Code checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # -----------------------------
      # æ­¥é©Ÿ 2ï¼šä½¿ç”¨ Maven ç·¨è­¯å°ˆæ¡ˆï¼ˆcompile + test + packageï¼‰
      # mvn install â†’ æœƒç”¢ç”Ÿ .war èˆ‡å®‰è£åˆ°æœ¬åœ° Maven repo
      # -----------------------------
      - name: Maven Build
        run: mvn install

      # -----------------------------
      # æ­¥é©Ÿ 3ï¼šä¸Šå‚³å»ºç½®å¾Œçš„ WAR æª”æ¡ˆ
      # actions/upload-artifact â†’ ä¾¿æ–¼å¾ŒçºŒ Job æˆ–æ‰‹å‹•ä¸‹è¼‰
      # -----------------------------
      - name: Upload Build Artifact (WAR)
        uses: actions/upload-artifact@v4
        with:
          name: vprofile-app         # Artifact åç¨±
          path: target/*.war         # WAR æª”æ¡ˆè·¯å¾‘

      # -----------------------------
      # æ­¥é©Ÿ 4ï¼šåœ¨ Build å¤±æ•—æ™‚è¼¸å‡ºè¨Šæ¯
      # if: failure() â†’ åƒ…æ–¼å‰é¢æ­¥é©Ÿæœ‰éŒ¯èª¤æ™‚åŸ·è¡Œ
      # -----------------------------
      - name: Notify if Build Fails
        if: failure()
        run: echo "ğŸš¨ Build job failed! Please check logs."


  # ======================================================
  # Job 2ï¼šTestingï¼ˆæ ¹æ“šåˆ†æ”¯åŸ·è¡Œä¸åŒæ¸¬è©¦ï¼‰
  #   - main åˆ†æ”¯ â†’ è·‘å®Œæ•´å–®å…ƒæ¸¬è©¦ + checkstyle
  #   - å…¶ä»–åˆ†æ”¯ â†’ è·³é
  # ======================================================
  Testing:
    runs-on: ubuntu-latest
    needs: Build        # å¿…é ˆç­‰ Build Job å®Œæˆ

    steps:
      # -----------------------------
      # åŒæ¨£éœ€è¦ä¸‹è¼‰ç¨‹å¼ç¢¼ï¼Œå› ç‚ºä¸åŒ Job çš„å·¥ä½œç›®éŒ„ä¸å…±äº«
      # -----------------------------
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # main åˆ†æ”¯ â†’ åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      # github.ref æœƒè¼¸å‡ºå®Œæ•´ refsï¼Œä¾‹å¦‚ï¼šrefs/heads/main
      # -----------------------------
      - name: Run tests on main branch
        if: github.ref == 'refs/heads/main'
        run: mvn test

      # -----------------------------
      # main åˆ†æ”¯ â†’ åŸ·è¡Œ Checkstyle ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
      # -----------------------------
      - name: Checkstyle
        if: github.ref == 'refs/heads/main'
        run: mvn checkstyle:checkstyle

      # -----------------------------
      # é main åˆ†æ”¯ â†’ æ¸›å°‘ CI æ™‚é–“ï¼Œä¸åŸ·è¡Œæ¸¬è©¦
      # -----------------------------
      - name: Run tests on other branches
        if: github.ref != 'refs/heads/main'
        run: echo "Skipping unit tests and code analysis"


  # ======================================================
  # Job 3ï¼šSecurity_Scanï¼ˆä½¿ç”¨ Trivy åšæ¼æ´æƒæï¼‰
  # æƒæç›®æ¨™ï¼šOS æ¼æ´ + Library æ¼æ´
  # çµæœè¼¸å‡º JSON
  # ======================================================
  Security_Scan:
    runs-on: ubuntu-latest
    needs: Build

    steps:
      # -----------------------------
      # ä¸‹è¼‰ç¨‹å¼ç¢¼ä»¥é€²è¡Œ filesystem æƒæ
      # -----------------------------
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # ä½¿ç”¨ Trivy æƒæç›®éŒ„ï¼ˆscan-type: fsï¼‰
      # åƒæ•¸èªªæ˜ï¼š
      #   - scan-type: fs        æƒæ•´å€‹æª”æ¡ˆç³»çµ±ç›®éŒ„
      #   - scan-ref: .          æƒæç›®å‰ Repo
      #   - format: json         è¼¸å‡ºç‚º JSON æª”
      #   - exit-code: 0         æœ‰æ¼æ´ä¹Ÿä¸æœƒè®“ Job å¤±æ•—
      #   - vuln-type: os,library   æƒ OS ä»¥åŠç¨‹å¼å¥—ä»¶æ¼æ´
      #   - output: trivy-results.json   è¼¸å‡ºæª”å
      # -----------------------------
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: json
          exit-code: 0
          vuln-type: os,library
          output: trivy-results.json

      # -----------------------------
      # ä¸Šå‚³æƒæçµæœï¼Œä»¥ä¾¿æŸ¥çœ‹æ¼æ´å ±å‘Š
      # -----------------------------
      - name: Upload Trivy scan results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-results.json
