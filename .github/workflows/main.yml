# ------------------------------------------------------
# Workflow åç¨±
# ------------------------------------------------------
name: Vprofile CICD Workflow

# ------------------------------------------------------
# è§¸ç™¼æ¢ä»¶
# ------------------------------------------------------
on: 
  push:
    branches: 
      - main  # ç•¶ main åˆ†æ”¯æœ‰ commit push æ™‚è§¸ç™¼

  pull_request:
    branches: 
      - main  # ç•¶ main åˆ†æ”¯æœ‰ PR å»ºç«‹æ™‚è§¸ç™¼

  workflow_dispatch:  # å¯æ‰‹å‹•è§¸ç™¼ workflow

  schedule:
    - cron: "10 14 * * 1-5"   # å®šæ™‚è§¸ç™¼ï¼šé€±ä¸€åˆ°é€±äº” 14:10 (UTC+0)

# ------------------------------------------------------
# ç’°å¢ƒè®Šæ•¸
# ------------------------------------------------------
env:
  ECR_REPOSITORY: 'vprofile-appimage'  # Docker æ˜ åƒ repository åç¨±

# ------------------------------------------------------
# æ¬Šé™è¨­å®š
# ------------------------------------------------------
permissions: 
  contents: read  # åªè®€å– repo å…§å®¹å³å¯

# ------------------------------------------------------
# Jobs å€å¡Š
# ------------------------------------------------------
jobs:

  # ------------------------------------------------------
  # Build Job
  # ------------------------------------------------------
  Build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–° Ubuntu runner
    steps:
      # Checkout åŸå§‹ç¢¼
      - name: Code checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å–å¾—å®Œæ•´ commit historyï¼Œä¾¿æ–¼å¾ŒçºŒä½¿ç”¨

      # Maven Build
      - name: Maven Build
        run: mvn install  # ç·¨è­¯ä¸¦ç”Ÿæˆ WAR æª”

      # ä¸Šå‚³å»ºç½®ç”¢ç‰©
      - name: Upload Build Artifact (WAR)
        uses: actions/upload-artifact@v4
        with:
          name: vprofile-app  # artifact åç¨±
          path: target/*.war  # ä¸Šå‚³ç›®æ¨™

      # Build å¤±æ•—é€šçŸ¥
      - name: Notify if Build Fails
        if: failure()  # åªæœ‰ç•¶ Build å¤±æ•—æ™‚æ‰åŸ·è¡Œ
        run: echo "ğŸš¨ Build job failed! Please check logs."

  # ------------------------------------------------------
  # Testing Job
  # ------------------------------------------------------
  Testing:
    runs-on: ubuntu-latest
    needs: Build  # å¿…é ˆç­‰ Build å®Œæˆ
    steps:
      # Checkout åŸå§‹ç¢¼
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # é‡å° main branch åŸ·è¡Œæ¸¬è©¦
      - name: Run tests on main branch
        if: github.ref == 'refs/heads/main'
        run: mvn test

      # Checkstyle ç¨‹å¼ç¢¼æª¢æŸ¥
      - name: Checkstyle
        if: github.ref == 'refs/heads/main'
        run: mvn checkstyle:checkstyle

      # å…¶ä»–åˆ†æ”¯è·³éæ¸¬è©¦èˆ‡æª¢æŸ¥
      - name: Run tests on other branches
        if: github.ref != 'refs/heads/main'
        run: echo "Skipping unit tests and code analysis"

  # ------------------------------------------------------
  # Security Scan Job
  # ------------------------------------------------------
  Security_Scan:
    runs-on: ubuntu-latest
    needs: Build  # å¿…é ˆç­‰ Build å®Œæˆ
    steps:
      # Checkout åŸå§‹ç¢¼
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ä½¿ç”¨ Trivy åŸ·è¡Œ filesystem æƒæ
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .  # æƒæç•¶å‰ç›®éŒ„
          format: json  # è¼¸å‡ºæ ¼å¼ç‚º JSON
          exit-code: 0  # ä¸å› æ¼æ´å¤±æ•— workflow
          vuln-type: os,library  # æƒæ OS èˆ‡ library
          output: trivy-results.json  # è¼¸å‡ºæª”å

      # ä¸Šå‚³æƒæçµæœ
      - name: Upload Trivy scan results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-results.json

  # ------------------------------------------------------
  # Build and Publish Docker Image Job
  # ------------------------------------------------------
  BUILD_AND_PUBLISH:
    name: BUILD_AND_PUBLISH
    runs-on: ubuntu-latest
    environment: production  # ä½¿ç”¨ production environmentï¼Œå–å¾— secrets
    needs: [Build, Testing, Security_Scan]  # ä¾è³´ä¸‰å€‹å‰ç½® Job
    if: github.ref == 'refs/heads/main'  # åªå° main branch åŸ·è¡Œ
    steps:
      # Checkout åŸå§‹ç¢¼
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è¨­å®š AWS æ†‘è­‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  # å¾ secrets å–å¾— Access Key
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}  # å¾ secrets å–å¾— Secret Key
          aws-region: ${{ vars.AWS_REGION }}  # AWS Region å¾ workflow vars å–å¾—

      # ç™»å…¥ Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr  # step IDï¼Œå¯åœ¨å¾ŒçºŒä½¿ç”¨ outputs
        uses: aws-actions/amazon-ecr-login@v2

      # å»ºç½®ã€æ¨™è¨˜ã€ä¸¦æ¨é€ Docker æ˜ åƒ
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}  # å¾ login step output å–å¾— registry
          IMAGE_TAG: ${{ github.sha }}  # ä½¿ç”¨ commit SHA ä½œç‚º tag
	
        run: |
		
		# å»ºç½® Docker æ˜ åƒ
          docker build -f Docker-files/app/multistage/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        
		# æ¨è‡³ECR  
		  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
