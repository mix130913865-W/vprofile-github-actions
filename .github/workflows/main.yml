# ------------------------------------------------------
# Workflow 名稱：會顯示在 GitHub Actions 頁面左側清單
# ------------------------------------------------------
name: Vprofile CICD Workflow

# ------------------------------------------------------
# on: 代表觸發條件（什麼時候要執行這個 Pipeline）
# ------------------------------------------------------
on:

  # 1) push：當 push 到指定分支時觸發
  push:
    branches: [ "main", "develop" ]   # main 和 develop 兩個分支 push 都會觸發

  # 2) pull_request：當 PR 目標分支是 main / develop 時觸發
  pull_request:
    branches: [ "main", "develop" ]

  # 3) workflow_dispatch：允許手動按按鈕執行（Run workflow）
  workflow_dispatch:

  # 4) schedule：定時排程
  #    cron 表示每天 UTC 時區凌晨 2 點自動執行
  schedule:
    - cron: "0 2 * * *"

# ------------------------------------------------------
# jobs：這個 Workflow 裡面包含的所有工作階段（Job）
# ------------------------------------------------------
jobs:

  # ======================================================
  # 第一個 Job：Build（編譯 + 打包）
  # ======================================================
  Build:
    # GitHub 提供的 Ubuntu Runner
    runs-on: ubuntu-latest

    steps:
      # Step 1：將 Repo 原始碼 checkout 到 runner 主機
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 下載完整 git 歷史（避免某些插件無法找到 commit）

      # Step 2：執行 Maven Build
      # mvn install = compile + test + package
      - name: Maven Build
        run: mvn install


  # ======================================================
  # 第二個 Job：Testing（單元測試、Checkstyle）
  # ======================================================
  Testing:
    runs-on: ubuntu-latest

    # needs: Build → 必須等 Build Job 成功才會執行 Testing
    needs: Build

    steps:
      # Step 1：再次 checkout 原始碼（確保乾淨測試環境）
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2：Maven 測試（執行單元測試 + 整合測試）
      - name: Run tests on main branch
        run: mvn test

      # Step 3：Checkstyle 程式碼風格檢查
      - name: Checkstyle
        run: mvn checkstyle:checkstyle